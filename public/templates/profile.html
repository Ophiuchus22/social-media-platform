<!DOCTYPE html>
<html lang="en" ng-app="socialMediaApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Fishbonk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="profileController.js"></script>
    <script src="profileService.js"></script>
    <style>
        .post-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .post-user-image {
            width: 40px;
            height: 40px;
        }

        .post-content {
            margin: 0;
        }

        .likes-comments-count {
            font-size: 17px;
            color: #606770;
            margin-bottom: 0;
            margin-top: 20px;
        }

        .post-actions {
            padding: 4px 0;
        }

        .post-actions .btn {
            color: #65676b;
            margin: 0 5px;
            padding: 0;
        }

        hr {
            margin: 5px 0;
        }

        .comment {
            margin-top: 5px;
        }

        .comment-input {
            border-radius: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body class="bg-light" ng-controller="ProfileController">
    <!-- Header -->
    <header class="container-fluid py-3 bg-white shadow-sm sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center cursor-pointer" ng-click="goToPosts()">
                <img src="/logo/2.png" alt="Fishbook Logo" class="img-fluid me-3" style="height: 50px;">
            </div>
            <div class="d-flex align-items-center" ng-controller="MainController">
                <a href="#!/profile" class="d-flex align-items-center text-decoration-none text-dark me-4">
                    <img ng-src="{{ user.profile_picture ? user.profile_picture : '/logo/default.png' }}" 
                         alt="User Profile" 
                         class="rounded-circle me-2 shadow-sm" 
                         style="width: 40px; height: 40px;">
                    <span class="fw-medium">{{ user.name }}</span>
                </a>
                <button ng-click="logout()" class="btn btn-danger">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <!-- Profile Section -->
                <div class="card mb-4 border-2 shadow p-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 id="my-profile" class="h4 fw-bold">My Profile</h2>
                            <button ng-click="toggleEdit()" class="btn btn-primary">
                                {{ isEditing ? 'Cancel' : 'Edit' }}
                            </button>
                        </div>
                        <div class="d-flex align-items-center mt-4">
                            <img ng-src="{{ user.profile_picture ? user.profile_picture : '/logo/default.png' }}" 
                                 alt="Profile Picture" 
                                 class="rounded-circle me-3 shadow-sm" 
                                 style="width: 80px; height: 80px;">
                            <div>
                                <h3 class="h5 fw-bold">{{ user.name }}</h3>
                                <p class="text-muted">{{ user.email }}</p>
                            </div>
                        </div>
                        <div class="mt-4" ng-if="!isEditing">
                            <strong class="text-dark"></strong>
                            <p class="text-muted">{{ user.bio || 'No bio available' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Post Creation Section -->
                <div class="card mb-3 border-2 shadow-sm p-2">
                    <div class="card-body">
                        <h5 class="card-title">Create Post</h5>
                        <form ng-submit="createPost()">
                            <div class="mb-2">
                                <textarea ng-model="newPost.content" required class="form-control" placeholder="What's on your mind?" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-30">
                                <i class="fas fa-paper-plane me-1"></i> Post
                            </button>
                        </form>
                    </div>
                </div>

                <!-- My Posts Section -->
                <div>
                    <div class="card-body">
                        <h2 class="h4 fw-bold mb-3">My Posts</h2>

                        <div class="post-container border-2 shadow-sm" ng-repeat="post in posts">
                            <div class="post-header">
                                <div class="d-flex align-items-center">
                                    <img ng-src="{{ user.profile_picture }}" alt="{{ user.name }}" class="rounded-circle me-2 post-user-image">
                                    <div>
                                        <p class="mb-0 fw-semibold">{{ user.name }}</p>
                                        <small class="text-muted">{{ post.created_at | date:'medium' }}</small>
                                    </div>
                                </div>

                                <!-- Dropdown menu for edit and delete -->
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                        <li>
                                            <a class="dropdown-item" ng-click="editPost(post)">Edit</a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger" ng-click="deletePost(post)">Delete</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Post Content -->
                            <p ng-hide="post.editing" class="post-content">{{ post.content }}</p>

                            <!-- Edit Section -->
                            <div ng-show="post.editing">
                                <form ng-submit="savePost(post)">
                                    <textarea ng-model="post.editedContent" required class="form-control mb-2"></textarea>
                                    <div class="d-flex justify-content-between">
                                        <button type="submit" class="btn btn-success">Save</button>
                                        <button type="button" ng-click="cancelEdit(post)" class="btn btn-secondary">Cancel</button>
                                    </div>
                                </form>
                            </div>

                            <div class="likes-comments-count mb-2 d-flex justify-content-between">
                                <span>{{ post.likes_count }} Likes</span>
                                <span>{{ post.comments_count }} Comments</span>
                            </div>

                            <hr>

                            <!-- Like and Comment Buttons -->
                            <div class="post-actions d-flex justify-content-between">
                                <button ng-click="toggleLike(post)" class="btn btn-link text-decoration-none">
                                    <i class="fas fa-like"></i>{{ post.is_liked ? '‚ù§Ô∏è' : 'ü§ç' }} Like
                                </button>
                                <button ng-click="post.showComments = !post.showComments" class="btn btn-link text-decoration-none">
                                    <i class="fas fa-comment"></i> Comment
                                </button>
                            </div>

                            <!-- Comment Section -->
                            <div class="mt-3" ng-if="post.showComments">
                                <div class="comment mb-2" ng-repeat="comment in post.comments">
                                    <div class="bg-light p-2 rounded w-100">
                                        <div class="d-flex justify-content-between">
                                            <strong>{{ comment.user.name }}</strong>
                                            <button class="btn btn-sm text-danger" ng-click="deleteComment(post, comment)" ng-if="comment.user.id === user.id">Delete</button>
                                        </div>
                                        {{ comment.content }}
                                    </div>
                                </div>

                                <form ng-submit="addComment(post)" class="d-flex">
                                    <input ng-model="post.newComment" required class="form-control me-2 comment-input" placeholder="Write a comment...">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                                </form>
                            </div>
                        </div>

                        <div ng-if="posts.length === 0" class="text-center text-muted">
                            <p>No posts available.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Adjusted modal size to modal-lg -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form ng-submit="updateProfile()">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" id="name" ng-model="user.name" required class="form-control">
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" id="email" ng-model="user.email" required class="form-control" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio</label>
                            <textarea id="bio" ng-model="user.bio" class="form-control"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="profile_picture" class="form-label">Profile Picture</label>
                            <input type="file" id="profile_picture" onchange="angular.element(this).scope().onFileSelect(this.files)" class="form-control">
                        </div>

                        <button type="submit" class="btn btn-success w-100">Update Profile</button> <!-- Full width button -->
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Styles -->
    <style>
        .modal-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Final position */
            max-width: 600px; /* Set a max width for the modal */
            width: 100%; /* Ensure it adapts to different screen sizes */
            z-index: 1055; /* Ensure it's above other content */
        }
    
        .modal-backdrop {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }
    
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out; /* Transition for smooth animation */
            transform: translate(-50%, -60%); /* Start slightly above the center */
        }
    
        .modal.show .modal-dialog {
            transform: translate(-50%, -50%); /* Move to the final center position */
        }
    
        body.modal-open {
            padding-right: 0 !important; /* Prevent scrollbar issues */
            overflow: hidden;
        }
    </style>    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
